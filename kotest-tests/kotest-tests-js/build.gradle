plugins {
   id("java")
   id("kotlin-multiplatform")
   id("java-library")
   id("com.adarshr.test-logger")
   id "com.github.node-gradle.node" version "2.2.4"
}

kotlin {

   js {
      browser()
   }

   sourceSets {

      commonTest {
         dependencies {
            implementation(project(Projects.Api))
            implementation(project(Projects.Core))
            implementation(project(Projects.AssertionsCore))
         }
      }

      jsTest {
         dependsOn(commonTest)
      }
   }
}

compileKotlinJs.configure {
   kotlinOptions {
      moduleKind = 'commonjs'
   }
}

task copyJsDependencies(type: Copy, dependsOn: compileTestKotlinJs) {
   from compileKotlinJs.destinationDir
   into "${buildDir}/node_modules"

   def configuration = configurations.jsTestRuntimeClasspath
   from(files {
      configuration.collect { File file ->
         file.name.endsWith(".jar")
            ? zipTree(file.absolutePath).matching {
            include '*.js'
            include '*.js.map'
         } : files()
      }
   }.builtBy(configuration))
}

node {
   download = true
}

task installMocha(type: NpmTask) {
   args = ['install', 'mocha']
}

task runMocha(type: NodeTask, dependsOn: [installMocha, compileTestKotlinJs, copyJsDependencies]) {
   script = file('node_modules/mocha/bin/mocha')
   args = [compileTestKotlinJs.outputFile]
}

jsTest.dependsOn runMocha
